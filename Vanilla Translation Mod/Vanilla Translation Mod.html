<!DOCTYPE html>
<html>
	<head>
		<title>Stick Ranger Vanilla Translation Mods</title>
        <style>
            #cv:-webkit-full-screen{
                image-rendering: pixelated;
                image-rendering: -moz-crisp-edges;
                image-rendering: crisp-edges;
                -ms-interpolation-mode: nearest-neighbor;
                background-color: black;
                object-fit: contain;
                position: fixed;
                width: 100%;
                height: 100%;
            }
        </style>
	</head>

	<body style="background-color:#0F0F0F; overflow:hidden; display:flex;">
		<div style="float:left">
			<div id="disable_electron_warnings">
				<script type="text/javascript">process.env['ELECTRON_DISABLE_SECURITY_WARNINGS'] = 'true';</script>
			</div>
			<div id="game_canvas">
				<canvas id="cv"></canvas>
				<script src="Vanilla Translation Mod.js"></script>
				<script type="text/javascript">Init("1",1,0);</script>
			</div>
			<div id="saveCode" style="width:512px;">
				<script type="text/javascript">
					function saveCode(){
						var save_html = '';
						save_html += '<table class="ctbl"><tr><td><textarea id="inputBox" rows="1" cols="48" onclick="this.select();"><\/textarea><\/td>';
						save_html += '<td><input type="submit" value="Get" onclick="getCode()" onmousedown="document.getElementById(\'inputBox\').value=\'\';">';
						save_html += '<input type="submit" value="Set" onclick="load()";><\/td><\/tr><br>';

						document.getElementById('saveCode').innerHTML = save_html;
					}
					saveCode();
				</script>
				<script type="text/javascript">
					function getCode(){
						var save_string = GameSave('0');

						if(save_string!='')
							document.getElementById('inputBox').value = save_string;
					}

					function load(){
						document.getElementById('inputBox').value = document.getElementById('inputBox').value.replace(/\x0D\x0A|\x0D|\x0A/g,'');
						var save_string = document.getElementById('inputBox').value;

						if(save_string!='')
							GameLoad(save_string);
					}
				</script>
			</div>
			<div id="fullScreenButton">
				<input type="submit" value="Full Screen" onclick="fullScreen();" />
			</div>
		</div>
		<div style="float:right; width:256px; background-color: rgb(51, 51, 51); color:white; display:flex; flex-direction:column; align-items:center; border-radius: 10px;">
			<div id="APConnection" style="display:flex; flex-direction:column; align-items:center; ">
				<p>Archipelago connection</p>
				<table>
					<tr>
						<td>Host:</td>
						<td><input type="text" id="host" placeholder="archipelago.gg" value="archipelago.gg"></td>
					</tr>
					<tr>
						<td>Port:</td>
						<td><input type="text" id="port" placeholder="35556"></td>
					</tr>
					<tr>
						<td>Slot name:</td>
						<td><input type="text" id="slotName" placeholder="Slot name"></td>
					</tr>
					<tr>
						<td>Password:</td>
						<td><input type="password" id="password"></td>
					</tr>
				</table>
				<button id="connect">Connect</button>
			</div>
			<div id="chat" style="width:244px; height:100%; border:2px solid rgb(76, 76, 76); border-radius:3px; overflow-y:auto; padding:4px; font-family:monospace; font-size:0.9em;">
				
			</div>
			<script type="module">
				const { Client, ITEMS_HANDLING_FLAGS, SERVER_PACKET_TYPE, CREATE_AS_HINT_MODE, CLIENT_STATUS, CONNECTION_STATUS, CLIENT_PACKET_TYPE, SetOperationsBuilder } = await import("https://unpkg.com/archipelago.js@1.0.0/dist/archipelago.js");
				var receivedItems = []
				const host = document.getElementById('host');
				const port = document.getElementById('port');
				const slotName = document.getElementById('slotName');
				const password = document.getElementById('password');
				const connectButton = document.getElementById('connect');
				const apDiv = document.getElementById('APConnection');
				const chatDiv = document.getElementById('chat');

				connectButton.addEventListener('click', () => connectToAP());

				function connectToAP(){
					window.client = new Client();
					
					const connectionInfo = {
						hostname: host.value,
						port: parseInt(port.value),
						game: 'Stick Ranger',
						name: slotName.value,
						password: password.value,
						items_handling: ITEMS_HANDLING_FLAGS.REMOTE_ALL,
					};

					window.client.addListener(SERVER_PACKET_TYPE.CONNECTED, (packet) => {
						appendFunctions();
						if (
							localStorage.getItem('host') === host.value
							&& localStorage.getItem('port') === port.value
							&& localStorage.getItem('slotName') === slotName.value
							&& localStorage.getItem('password') === password.value
						) {
							//TODO test deze dingen met logs om te kijken of saves bewaard kunnen blijven als je opslaat, of maybe sturen naar ap zodat de state altijd opgevraagd kan worden?
							GameLoad(localStorage.getItem('save').replace(/\x0D\x0A|\x0D|\x0A/g,''))
						} else {
							save();
						}
					});

					window.client.addListener(SERVER_PACKET_TYPE.ROOM_UPDATE, (packet) => {
						console.log("Room update: ", packet);
					});

					window.client.addListener(SERVER_PACKET_TYPE.RECEIVED_ITEMS, (packet) => {
						console.log("Received Items: ", packet);

						// When items.length > 1 it's a reconnect
						if(packet.items.length > 1) {
							var serverItems = [];

							// Execute Items with firstTime = false > only Unlocks, no Traps or Items
							// TODO look at new game?
							packet.items.forEach(item => {
								receiveItem(item.item, false);
								serverItems.push(item.item);
							});
							
							// Compare serverItems with local saved (and executed Items)
							let difference = serverItems.filter(item => !receivedItems.includes(item));
							console.log("serverItems")
							console.log(serverItems)

							console.log("receivedItems")
							console.log(receivedItems)

							console.log("difference")
							console.log(difference)

							difference.forEach(id => {
								receiveItem(id, true);
							});

						} else { // Just one Item means its new > always use
							receiveItem(packet.items[0].item, true);
						}
					});

					window.client.addListener(SERVER_PACKET_TYPE.LOCATION_INFO, (packet) => {
						console.log("Hint: ", packet);
					});

					window.client.addListener(SERVER_PACKET_TYPE.PRINT_JSON, (packet) => {
						const msg = packetToText(packet.data);
						if (msg === "") {
							return;
						}
						console.log(packet);
						addToChat(msg);
					});

					window.client
						.connect(connectionInfo)
						.then(() => {
							connectButton.disabled = true;
							host.disabled = true;
							port.disabled = true;
							slotName.disabled = true;
							password.disabled = true;
							apDiv.style.display = 'none';
						})
						.catch((error) => {
							console.error("Failed to connect:", error.toString());
							connectButton.disabled = true;
							host.disabled = true;
							port.disabled = true;
							slotName.disabled = true;
							password.disabled = true;
						});

					window.addEventListener("beforeunload", () => {
						localStorage.setItem('save', GameSave('0'))
						window.client.disconnect();
					});
				}

				function addToChat(text) {
					const msg = document.createElement('div');
					msg.style.borderBottom = "2px solid rgb(44, 44, 44)"
					msg.textContent = text;
					chatDiv.appendChild(msg);
					chatDiv.scrollTop = chatDiv.scrollHeight;
				}

				function packetToText(packet) {
					if (packet === undefined) {
						return "";
					}
					var msg = "";
					packet.forEach(element => {
						msg += typeToText(element) + " ";
					});
					return msg;
				}

				function typeToText(element) {
					var id = -1;
					id = Number(element.text);
					var playerId = window.client.data.slotData.player_id;
					
					if(element.player !== undefined) {
						playerId = Number(element.player);
					}
					if (element.type === "player_id" && !isNaN(id)) {
						return window.client.players.name(Number(id));
					} else if (element.type === "item_id" && !isNaN(id)) {
						return window.client.items.name(window.client.players.game(Number(playerId)), Number(id))
					} else if (element.type === "location_id" && !isNaN(id)) {
						return window.client.locations.name(window.client.players.game(Number(playerId)), Number(id))
					}
					else if (element.text !== undefined) {
						return element.text;
					} else {
						return element;
					}
				}

				function save() {
					localStorage.setItem('receivedItems', JSON.stringify(receivedItems))
					localStorage.setItem('host', host.value);
					localStorage.setItem('port', port.value);
					localStorage.setItem('slotName', slotName.value);
					localStorage.setItem('password', password.value);
					localStorage.setItem('save', GameSave('0'))
				}

				function appendFunctions() {
					// TODO: Add SR logic to modify screen (like obtaining items)
				}

				const BEATEN = 2;
				const checkIdOffset = 10000;

				let prev = Stage_Status.slice();

				setInterval(() => {
					Stage_Status.forEach((status, stageIdx) => {
						if ((prev[stageIdx] & BEATEN) === 0 && (status & BEATEN) !== 0) {
							const checkId = stageIdx + checkIdOffset;
							sendCheckToAP(checkId);
						}
					});
					prev = Stage_Status.slice();
				}, 500);

				function sendCheckToAP(id) {
					window.client.locations.check(id);
				}

				function receiveItem(itemId, firstTime) {
					const LOCATION_ID_OFFSET = 11000;
					if (itemId >= LOCATION_ID_OFFSET && itemId < LOCATION_ID_OFFSET + 1000) {
						
						const stageIdx = itemId - LOCATION_ID_OFFSET;
						console.log(stageIdx);
						Stage_Status[stageIdx] |= Unlocked;
						localStorage.setItem('save', GameSave('0'))
						antiCheatSet();
					}
					else {
						// …or handle any other “real” items here…
					}
				}
			</script>
		</div>
	</body>
</html>